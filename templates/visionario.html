<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Analista Contábil - Macro</title>
    <style>
        :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --accent: #238636; --blue: #58a6ff; --red: #f85149; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .full { grid-column: 1 / -1; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; position: relative; }
        .card h3 { margin: 0 0 10px 0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        .val-macro { font-size: 1.8rem; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        th { text-align: left; color: #8b949e; border-bottom: 1px solid var(--border); padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #21262d; }
        .val-pos { color: #3fb950; font-weight: bold; }
        .val-neg { color: var(--red); }
        .btn { background: #21262d; color: #c9d1d9; border: 1px solid var(--border); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:hover { background: var(--border); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analista <small style="font-size: 12px; color: var(--blue);">Consolidado Histórico</small></h1>
            <button class="btn" onclick="fetchData()">Recarregar Dados</button>
        </div>

        <div class="grid">
            <div class="card" style="border-top: 4px solid var(--blue);">
                <h3 style="color: var(--blue);">Faturamento Bruto</h3>
                <div class="val-macro" id="total_vendas">R$ 0,00</div>
            </div>
            <div class="card" style="border-top: 4px solid var(--red);">
                <h3 style="color: var(--red);">Custo Operacional</h3>
                <div class="val-macro" id="total_gastos">R$ 0,00</div>
            </div>
            <div class="card" style="border-top: 4px solid var(--accent);">
                <h3 style="color: var(--accent);">Lucro Líquido</h3>
                <div class="val-macro" id="total_lucro">R$ 0,00</div>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card full">
                <h3>Auditoria de Fluxo Mensal (Cronológico)</h3>
                <table id="tab-auditoria">
                    <thead><tr><th>Mês</th><th>Vendas</th><th>Gastos</th><th>Lucro</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Maiores Clientes</h3>
                <table id="tab-clientes">
                    <thead><tr><th>Comprador</th><th>Total</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Produtos Mais Rentáveis</h3>
                <table id="tab-produtos">
                    <thead><tr><th>Sabor</th><th>Total</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const fmt = (v) => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

        async function fetchData() {
            const res = await fetch('/api/v1/ml_visionario');
            const d = await res.json();
            if(d.erro) { alert("Erro: " + d.erro); return; }

            // Dash Totais
            document.getElementById('total_vendas').innerText = fmt(d.totais.faturamento);
            document.getElementById('total_gastos').innerText = fmt(d.totais.custos);
            document.getElementById('total_lucro').innerText = fmt(d.totais.lucro);

            const draw = (id, data, keys) => {
                document.querySelector(`#${id} tbody`).innerHTML = data.map(row => 
                    `<tr>${keys.map(k => {
                        let v = row[k];
                        let style = (k === 'lucro' && v < 0) ? 'class="val-neg"' : (k === 'lucro' ? 'class="val-pos"' : '');
                        return `<td ${style}>${typeof v === 'number' ? fmt(v) : v}</td>`;
                    }).join('')}</tr>`
                ).reverse().join(''); // Mês mais recente no topo
            };

            draw('tab-auditoria', d.auditoria_mensal, ['mes', 'vendas', 'gastos', 'lucro']);
            draw('tab-clientes', d.ranking_compradores, ['CLIENTE', 'VALOR']);
            draw('tab-produtos', d.ranking_produtos, ['SABOR', 'VALOR']);
        }
        fetchData();
    </script>
</body>
</html>
