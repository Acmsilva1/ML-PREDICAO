<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Analista Vision√°rio | Macro</title>
    <style>
        :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --accent: #238636; --blue: #58a6ff; --red: #f85149; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
        .card h3 { margin: 0 0 10px 0; font-size: 0.75rem; text-transform: uppercase; color: #8b949e; }
        .val-macro { font-size: 1.8rem; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: #8b949e; border-bottom: 1px solid var(--border); padding: 12px; font-size: 0.7rem; }
        td { padding: 12px; border-bottom: 1px solid #21262d; }
        .val-pos { color: #3fb950; }
        .val-neg { color: var(--red); }
        .capitalize { text-transform: capitalize; }
    </style>
</head>
<body>
    <div class="container" id="main-content">
        <div class="header">
            <h1>Analista Vision√°rio <small style="font-size: 12px; color: var(--blue);">Governan√ßa Macro</small></h1>
            <button onclick="fetchData()" style="cursor:pointer; background:#21262d; color:#fff; border:1px solid var(--border); padding:8px 15px; border-radius:6px;">üîÑ Atualizar BI</button>
        </div>

        <div class="grid">
            <div class="card"><h3>Faturamento</h3><div class="val-macro" id="total_vendas">R$ 0,00</div></div>
            <div class="card"><h3>Despesas</h3><div class="val-macro val-neg" id="total_gastos">R$ 0,00</div></div>
            <div class="card"><h3>Lucro Consolidado</h3><div class="val-macro val-pos" id="total_lucro">R$ 0,00</div></div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h3>üèÜ TOP 10 PRODUTOS (VENDAS)</h3>
                <table>
                    <thead><tr><th>Sabor</th><th>Volume</th><th>Receita</th></tr></thead>
                    <tbody id="corpo-produtos"></tbody>
                </table>
            </div>
            <div class="card" style="border-top: 3px solid var(--red);">
                <h3>üìâ CALCANHAR DE AQUILES (GASTOS REAIS)</h3>
                <table>
                    <thead><tr><th>Insumo</th><th>Qtd Acumulada</th><th>Total Gasto</th></tr></thead>
                    <tbody id="corpo-gastos"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const fmt = (v) => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

        async function fetchData() {
            try {
                const res = await fetch('/api/v1/ml_visionario');
                const d = await res.json();
                
                document.getElementById('total_vendas').innerText = fmt(d.totais.faturamento);
                document.getElementById('total_gastos').innerText = fmt(d.totais.custos);
                document.getElementById('total_lucro').innerText = fmt(d.totais.lucro);

                document.getElementById('corpo-produtos').innerHTML = d.ranking_produtos.map(p => `
                    <tr><td class="capitalize">${p.SAB_LIST.toLowerCase()}</td><td>${p.qtd} un.</td><td class="val-pos">${fmt(p.total)}</td></tr>
                `).join('');

                // Inje√ß√£o do Volume Real
                document.getElementById('corpo-gastos').innerHTML = d.ranking_gastos.map(g => `
                    <tr><td class="capitalize">${g.PRODUTO.toLowerCase()}</td><td><strong>${g.volume_real}</strong> un/kg</td><td class="val-neg">${fmt(g.total_gasto)}</td></tr>
                `).join('');
            } catch (e) { console.error(e); }
        }
        fetchData();
    </script>
</body>
</html>
