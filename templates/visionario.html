<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Analista</title>
    <style>
        :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --accent: #58a6ff; --green: #238636; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full { grid-column: 1 / -1; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: #8b949e; border-bottom: 1px solid var(--border); padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #21262d; }
        .val-pos { color: #3fb950; font-weight: bold; }
        .val-neg { color: #f85149; }
        .box-previsao { background: #1c2128; border-left: 5px solid var(--accent); padding: 20px; margin-bottom: 25px; border-radius: 4px; }
        .btn { background: var(--green); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analista<small style="font-size: 12px; color: var(--accent);">Vendas totais</small></h1>
            <button class="btn" onclick="fetchData()">Recalcular Insights</button>
        </div>

        <div class="box-previsao">
            <h3 style="margin:0; font-size: 0.8rem; color: var(--accent);">TENDÊNCIA DE LUCRO PRÓXIMO MÊS</h3>
            <div style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;" id="previsao">R$ 0,00</div>
        </div>

        <div class="grid">
            <div class="card full">
                <h3>Auditoria de Fluxo Mensal</h3>
                <table id="tab-auditoria">
                    <thead><tr><th>Mês</th><th>Vendas</th><th>Gastos</th><th>Lucro</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Ranking Clientes</h3>
                <table id="tab-clientes">
                    <thead><tr><th>Comprador</th><th>Total</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Ranking Produtos</h3>
                <table id="tab-produtos">
                    <thead><tr><th>Sabor</th><th>Total</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function fetchData() {
            const res = await fetch('/api/v1/ml_visionario');
            const d = await res.json();
            if(d.erro) { alert("Erro nos dados: " + d.erro); return; }

            document.getElementById('previsao').innerText = d.previsao.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            const draw = (id, data, keys) => {
                document.querySelector(`#${id} tbody`).innerHTML = data.map(row => 
                    `<tr>${keys.map(k => {
                        let v = row[k];
                        let style = (k === 'lucro' && v < 0) ? 'class="val-neg"' : (k === 'lucro' ? 'class="val-pos"' : '');
                        return `<td ${style}>${typeof v === 'number' ? v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : v}</td>`;
                    }).join('')}</tr>`
                ).join('');
            };

            draw('tab-auditoria', d.auditoria_mensal, ['mes', 'vendas', 'gastos', 'lucro']);
            draw('tab-clientes', d.ranking_compradores, ['CLIENTE', 'VALOR']);
            draw('tab-produtos', d.ranking_produtos, ['SABOR', 'VALOR']);
        }
        fetchData();
    </script>
</body>
</html>
