<script>
    const fmt = (v) => v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

    async function fetchData() {
        const res = await fetch('/api/v1/ml_visionario');
        const d = await res.json();
        
        // Dash Totais (Adicionei o contador de itens no faturamento se quiser)
        document.getElementById('total_vendas').innerHTML = `${fmt(d.totais.faturamento)} <br><small style="font-size:12px">${d.totais.total_itens} itens</small>`;
        document.getElementById('total_gastos').innerText = fmt(d.totais.custos);
        document.getElementById('total_lucro').innerText = fmt(d.totais.lucro);

        // Auditoria Mensal com Ticket MÃ©dio
        const tbodyAuditoria = document.querySelector("#tab-auditoria tbody");
        tbodyAuditoria.innerHTML = d.auditoria_mensal.map(row => `
            <tr>
                <td>${row.mes}</td>
                <td>${fmt(row.vendas)}</td>
                <td>${fmt(row.gastos)}</td>
                <td class="${row.lucro >= 0 ? 'val-pos' : 'val-neg'}">${fmt(row.lucro)}</td>
                <td style="color: var(--blue)">${fmt(row.ticket_medio)}</td>
            </tr>
        `).reverse().join('');

        // Ranking de Produtos com QTD Real
        document.querySelector("#tab-produtos tbody").innerHTML = d.ranking_produtos.map(p => `
            <tr>
                <td style="text-transform: capitalize;">${p.SABOR.toLowerCase()}</td>
                <td>${p.QTD}</td>
                <td>${fmt(p.VALOR)}</td>
            </tr>
        `).join('');
    }
</script>
