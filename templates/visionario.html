<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Analista Contábil</title>
    <style>
        :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --accent: #238636; --blue: #58a6ff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full { grid-column: 1 / -1; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: #8b949e; border-bottom: 1px solid var(--border); padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #21262d; }
        .val-pos { color: #3fb950; font-weight: bold; }
        .val-neg { color: #f85149; }
        .box-macro { background: #1c2128; border-left: 5px solid var(--accent); padding: 20px; margin-bottom: 25px; border-radius: 4px; }
        .btn { background: #21262d; color: #c9d1d9; border: 1px solid var(--border); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn:hover { background: var(--border); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analista <small style="font-size: 12px; color: var(--blue);">Visão Macro Histórica</small></h1>
            <button class="btn" onclick="fetchData()">Atualizar Contador</button>
        </div>

        <div class="box-macro">
            <h3 style="margin:0; font-size: 0.8rem; color: var(--accent);">LUCRO TOTAL ACUMULADO (DESDE O INÍCIO)</h3>
            <div style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;" id="lucro_total">R$ 0,00</div>
        </div>

        <div class="grid">
            <div class="card full">
                <h3>Auditoria Mensal Completa</h3>
                <table id="tab-auditoria">
                    <thead><tr><th>Mês</th><th>Vendas</th><th>Gastos</th><th>Lucro Líquido</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Top Clientes (Vitalício)</h3>
                <table id="tab-clientes">
                    <thead><tr><th>Comprador</th><th>Total Gasto</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Top Produtos (Vitalício)</h3>
                <table id="tab-produtos">
                    <thead><tr><th>Sabor</th><th>Volume R$</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function fetchData() {
            const res = await fetch('/api/v1/ml_visionario');
            const d = await res.json();
            if(d.erro) { alert("Erro: " + d.erro); return; }

            // Atualiza o Lucro Macro
            document.getElementById('lucro_total').innerText = d.lucro_total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            const draw = (id, data, keys) => {
                document.querySelector(`#${id} tbody`).innerHTML = data.map(row => 
                    `<tr>${keys.map(k => {
                        let v = row[k];
                        let style = (k === 'lucro' && v < 0) ? 'class="val-neg"' : (k === 'lucro' ? 'class="val-pos"' : '');
                        let formatado = typeof v === 'number' ? v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : v;
                        return `<td ${style}>${formatado}</td>`;
                    }).join('')}</tr>`
                ).reverse().join(''); // Inverte para mostrar o mês mais recente primeiro
            };

            draw('tab-auditoria', d.auditoria_mensal, ['mes', 'vendas', 'gastos', 'lucro']);
            draw('tab-clientes', d.ranking_compradores, ['CLIENTE', 'VALOR']);
            draw('tab-produtos', d.ranking_produtos, ['SABOR', 'VALOR']);
        }
        fetchData();
    </script>
</body>
</html>
